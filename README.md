# Tanks Blitz Server (Учебный Проект)

## Описание

Этот проект представляет собой концептуальную серверную архитектуру для многопользовательской игры, подобной Tanks Blitz. Он был разработан в качестве учебного примера для демонстрации различных серверных технологий и паттернов проектирования.

**Основные реализованные и обсуждаемые возможности:**

*   Реализация паттернов Singleton (для `SessionManager` изначально) и Object Pool (для `TankObjectPool`).
*   Разделение TCP (аутентификация, управление сессиями) и UDP (синхронизация состояния игры) серверов.
*   Механизм дельта-обновлений для снижения трафика UDP.
*   Управление сессиями с использованием Redis для поддержки распределенной архитектуры.
*   Концептуальное описание интеграции Prometheus и Grafana для мониторинга.
*   Концептуальное описание использования Kubernetes для горизонтального масштабирования.
*   Концептуальное описание защиты от DDoS через Nginx.
*   Примеры юнит-тестов для ключевых компонентов.
*   Обсуждение подходов к нагрузочному тестированию.
*   Dockerfile'ы для упаковки сервисов и общие инструкции по деплою.

## Архитектура

Высокоуровневый обзор архитектуры:

*   **Клиент игры:** (Не реализован в этом проекте) Взаимодействует с сервером.
*   **Балансировщик нагрузки (Nginx):** Распределяет трафик, выполняет базовую защиту от DDoS.
*   **API-сервис (TCP):** Написан на Python (`asyncio`). Отвечает за аутентификацию, управление профилями и сессиями игроков. Использует `RedisSessionManager`.
*   **Игровой сервер (UDP):** Написан на Python (`asyncio`). Обрабатывает игровую логику матчей, синхронизирует состояние танков, использует дельта-обновления. Применяет `TankObjectPool`.
*   **Redis:** Используется для хранения сессий и потенциально для кэширования.
*   **Kubernetes:** Для оркестрации контейнеров, масштабирования и управления сервисами.
*   **Prometheus & Grafana:** Для сбора и визуализации метрик.

Более подробное описание архитектуры можно найти в (предполагаемом) `docs/architecture.md`.

## Технологический стек

*   **Язык:** Python 3.10+
*   **Сетевое взаимодействие:** `asyncio` для TCP и UDP серверов.
*   **Управление сессиями:** Redis
*   **Контейнеризация:** Docker
*   **Оркестрация:** Kubernetes (концептуально)
*   **Мониторинг:** Prometheus, Grafana (концептуально)
*   **Веб-сервер/Reverse Proxy:** Nginx (концептуально)
*   **Тестирование:** `unittest` (Python), Locust (для нагрузочного тестирования, обсуждался)

## Структура проекта

```
tanks_blitz_server/
├── docs/                      # Документация
├── src/                       # Исходный код
│   ├── api_service/           # TCP API-сервис
│   ├── game_server/           # UDP Игровой сервер
│   ├── common/                # Общие модули (напр., RedisSessionManager)
│   └── tests/                 # Тесты (unit, load)
├── deployments/               # Файлы для деплоя (Dockerfiles, Kubernetes YAMLs)
│   ├── Dockerfile.api
│   ├── Dockerfile.gameserver
│   ├── kubernetes/
│   └── nginx/
├── scripts/                   # Вспомогательные скрипты
├── README.md                  # Этот файл
└── requirements.txt           # Зависимости Python
```

## Требования для локального запуска

*   Python 3.10 или выше
*   `pip` (менеджер пакетов Python)
*   Redis (локально запущенный сервер или доступ к удаленному)
*   Docker (для сборки образов и запуска в контейнерах)
*   (Опционально) `kubectl` и кластер Kubernetes для деплоя.

## Инструкции по установке и настройке

1.  **Клонировать репозиторий:**
    ```bash
    git clone <URL_репозитория>
    cd tanks_blitz_server
    ```

2.  **Создать и активировать виртуальное окружение (рекомендуется):**
    ```bash
    python -m venv venv
    source venv/bin/activate  # для Linux/macOS
    # venv\Scriptsctivate   # для Windows
    ```

3.  **Установить зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

## Локальный запуск (для разработки)

Перед запуском убедитесь, что у вас запущен и доступен сервер Redis (по умолчанию `localhost:6379`).

1.  **Запуск API-сервиса (TCP):**
    ```bash
    python src/api_service/server.py
    ```
    Сервер запустится на `127.0.0.1:8888` по умолчанию.

2.  **Запуск Игрового сервера (UDP):**
    ```bash
    python src/game_server/server.py
    ```
    Сервер запустится на `127.0.0.1:9999` по умолчанию.

## Запуск тестов

Для запуска юнит-тестов выполните из корневой директории проекта:

```bash
python -m unittest discover src/tests/unit
```
Это запустит все тесты в директории `src/tests/unit`. Убедитесь, что Redis доступен для тестов `RedisSessionManager` (хотя они используют мок, но сам модуль Redis должен быть установлен).

## Сборка Docker-образов

Инструкции по сборке находятся в Dockerfile'ах в директории `deployments/`.

1.  **Сборка образа API-сервиса:**
    ```bash
    docker build -t tanks-api-service:latest -f deployments/Dockerfile.api .
    ```

2.  **Сборка образа Игрового сервера:**
    ```bash
    docker build -t tanks-gameserver:latest -f deployments/Dockerfile.gameserver .
    ```

## Развертывание (деплой)

Общие инструкции по деплою с использованием Kubernetes:

1.  Соберите и загрузите Docker-образы в ваш репозиторий контейнеров (Docker Hub, GCR, ECR и т.д.).
2.  Настройте и разверните Redis в вашем кластере Kubernetes (если еще не сделано).
3.  Адаптируйте и примените Kubernetes-манифесты из директории `deployments/kubernetes/` для API-сервиса и игрового сервера. Убедитесь, что в манифестах указаны правильные имена образов и конфигурация для подключения к Redis.
    ```bash
    # kubectl apply -f deployments/kubernetes/api_deployment.yaml
    # kubectl apply -f deployments/kubernetes/gameserver_deployment.yaml
    ```
4.  Настройте Ingress или LoadBalancer для доступа к сервисам.
5.  Настройте Horizontal Pod Autoscalers (HPA) для автоматического масштабирования.

Более подробное обсуждение деплоя было частью проектной документации.

## Мониторинг

Для мониторинга системы рекомендуется использовать Prometheus для сбора метрик и Grafana для их визуализации. Клиентская библиотека `prometheus-client` может быть интегрирована в Python-сервисы для экспорта кастомных метрик.

## Дальнейшие доработки и TODO

Этот проект является концептуальным, и многие аспекты могут быть доработаны:

*   **Реализация полной игровой логики** в `src/game_server/game_logic.py`.
*   **Более надежная обработка ошибок** и пограничных случаев во всех компонентах.
*   **Безопасность:** Усиление аутентификации, авторизации, защита от читов.
*   **Формат сообщений:** Переход с JSON на более эффективные бинарные форматы (например, Protocol Buffers) для UDP.
*   **Матчмейкинг:** Реализация логики подбора игроков.
*   **Персистентность данных игрока:** Интеграция с полноценной базой данных (например, PostgreSQL) для хранения профилей игроков, прогресса и т.д. (Redis используется в основном для сессий и кэша).
*   **Полная реализация CI/CD пайплайна.**
*   **Детальная настройка Nginx, Kubernetes манифестов.**
*   **Написание интеграционных и более полных нагрузочных тестов.**

```
